<!doctypehtml><html lang=zh-TW><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><title>即時投影</title><script src=https://unpkg.com/vue@3/dist/vue.global.js></script><script src=https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js></script><script src=https://cdn.tailwindcss.com></script><style>@import url(https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap);html{-webkit-overflow-scrolling:touch}body{font-family:Inter,'Noto Sans TC',sans-serif}video{width:100%;height:auto;display:block}.fade-enter-active,.fade-leave-active{transition:opacity .3s ease}.fade-enter-from,.fade-leave-to{opacity:0}.slide-up-enter-active,.slide-up-leave-active{transition:all .35s cubic-bezier(.16,1,.3,1)}.slide-up-enter-from,.slide-up-leave-to{transform:translateY(20px);opacity:0}</style></head><body class="min-h-screen bg-gradient-to-br from-slate-50 text-gray-800 to-indigo-50 via-blue-50"><div id=app class="flex flex-col min-h-screen"><header class="text-center px-4 py-8 shrink-0"><h1 class="mb-2 font-bold text-4xl">即時投影</h1><p class="text-gray-600 text-lg">你要看的，都讓你看</p></header><main class="w-full px-4 flex-grow max-w-4xl mx-auto pb-8"><transition name=fade mode=out-in><div v-if="view==='home'"key=home class="border backdrop-blur-xl bg-white/80 border-white/30 rounded-2xl shadow-xl p-8"><h2 class="text-center font-semibold mb-6 text-2xl">請選擇使用模式</h2><div class="gap-6 grid md:grid-cols-2"><div @click=startAsCamera class="border-2 bg-white border-transparent cursor-pointer duration-300 hover:-translate-y-1 hover:shadow-lg p-6 rounded-xl shadow-sm transition-all hover:border-blue-400"><div class=text-center><div class="mb-4 text-6xl">📱</div><h3 class="font-semibold text-xl mb-2">當作攝影機</h3><p class="text-sm text-gray-600">自動產生房號，並開始拍攝</p></div></div><div @click=startAsDisplay class="border-2 bg-white border-transparent cursor-pointer duration-300 hover:-translate-y-1 hover:shadow-lg p-6 rounded-xl shadow-sm transition-all hover:border-indigo-400"><div class=text-center><div class="mb-4 text-6xl">🖥️</div><h3 class="font-semibold text-xl mb-2">當作顯示端</h3><p class="text-sm text-gray-600">輸入房號，接收並顯示影像</p></div></div></div></div><div v-else-if="view==='displayInput'"key=display-input class="border backdrop-blur-xl bg-white/80 border-white/30 rounded-2xl shadow-xl p-8"><h2 class="text-center font-semibold mb-6 text-2xl">🖥️ 輸入房號</h2><div class="mx-auto max-w-xs"><div class=mb-4><label for=room-input class="text-sm block font-medium mb-2 text-gray-700">請輸入 4 位數房間號碼</label><input id=room-input v-model=inputRoomId type=text inputmode=numeric pattern=[0-9]* placeholder=例如：1234 maxlength=4 class="text-center border rounded-lg border-gray-300 focus:border-transparent focus:ring-2 focus:ring-indigo-500 font-mono outline-none px-4 py-3 shadow-sm text-3xl tracking-[0.2em] transition-all w-full"></div><div class="flex gap-3 flex-col sm:flex-row"><button @click=connectAsDisplay :disabled="inputRoomId.length!==4||isConnecting":class=primaryBtnClasses class="w-full disabled:cursor-not-allowed disabled:opacity-50"><span v-if=isConnecting>連線中...</span><span v-else>開始接收</span></button><button @click=goHome :class=secondaryBtnClasses class=w-full>返回</button></div></div></div><div v-else-if="view==='main'"key=main class=space-y-6><div class="border backdrop-blur-xl bg-white/80 border-white/30 rounded-2xl shadow-xl p-4"><div class="flex gap-3 items-center flex-wrap justify-between"><div class="flex gap-3 items-center"><span :class=status.indicatorClasses><span :class=status.dotClasses class="h-2.5 inline-block mr-2 rounded-full w-2.5"></span>{{status.text}}</span></div><div class="text-sm text-gray-600 bg-white/70 font-mono px-2 py-1 rounded">房號：<span class="font-semibold text-indigo-600">{{roomId}}</span></div></div></div><div v-if=isCamera class="border backdrop-blur-xl bg-white/80 border-white/30 rounded-2xl shadow-xl p-6 space-y-4"><h3 class="text-center font-semibold text-xl">🔗 分享資訊</h3><div class="text-center border rounded-lg bg-indigo-50 border-dashed border-indigo-200 p-4"><p class=text-indigo-800>請讓觀眾輸入房號 <strong class="text-4xl block font-mono my-2 tracking-widest">{{roomId}}</strong> 或分享下方連結</p></div><div class="flex gap-2"><label><input :value=shareUrl readonly class="border rounded-lg font-mono w-full bg-blue-50 border-blue-200 break-all p-2 text-blue-800 text-sm"></label><button @click=copyShareUrl :class=secondaryBtnClasses class=px-4 title=複製連結>📋</button><button v-if=canShare @click=shareViaWeb :class=secondaryBtnClasses class=px-4 title=分享>🔗</button></div><div v-if=!hasRemoteConnection class="text-center pt-2 animate-pulse text-gray-500">⏳ 等待顯示端連線...</div><div v-else class="text-center font-semibold pt-2 text-green-600">✅ 顯示端已連線！</div></div><div class="border backdrop-blur-xl bg-white/80 border-white/30 rounded-2xl shadow-xl p-4 sm:p-6"><div v-if="isCamera&&localStream"class="mx-auto max-w-xl"><h3 class="text-center font-semibold text-xl mb-4">📹 本機預覽</h3><div class="rounded-2xl bg-gray-900 border-2 border-white overflow-hidden shadow-lg"><video ref=localVideo autoplay muted playsinline></video></div></div><div v-if=isDisplay class=relative><div class="flex items-center shadow-lg bg-gray-900 border-2 border-white justify-center min-h-[250px] overflow-hidden rounded-2xl sm:min-h-[400px]"><video ref=remoteVideo autoplay playsinline :class="{'hidden':!hasRemoteStream}"></video><div v-if=!hasRemoteStream class="text-center p-8 text-white"><div class="mb-4 text-6xl animate-pulse">📺</div><h4 class="font-semibold text-xl">等待攝影機串流...</h4></div></div></div><div class="flex justify-center gap-4 mt-6"><button v-if=isCamera @click=switchCamera :class=secondaryBtnClasses>🔄 切換鏡頭</button><button v-if=isDisplay @click=toggleFullscreen :class=secondaryBtnClasses>🖼️ 全螢幕</button><button @click=disconnect :class=dangerBtnClasses>🛑 結束連線</button></div></div></div></transition><div class="-translate-x-1/2 bottom-6 fixed left-1/2 max-w-md space-y-3 w-11/12 z-50"><transition name=slide-up><div v-if=errorMessage class="border px-4 py-3 flex gap-3 items-center rounded-xl shadow-lg bg-red-100 border-red-300 text-red-800"><span class=text-xl>⚠️</span><p class=flex-grow>{{errorMessage}}</p><button @click="errorMessage=''"class="leading-none text-2xl text-red-500">×</button></div></transition><transition name=slide-up><div v-if=successMessage class="border px-4 py-3 flex gap-3 items-center rounded-xl shadow-lg bg-green-100 border-green-300 text-green-800"><span class=text-xl>✅</span><p class=flex-grow>{{successMessage}}</p><button @click="successMessage=''"class="leading-none text-2xl text-green-500">×</button></div></transition></div></main></div><script>const{createApp:c,ref:a,computed:t,onMounted:o,onUnmounted:e,nextTick:n}=Vue,r="wss://api-project.xinshou.tw/api/v1";c({setup(){const s=a("home"),l=a(null),i=a(""),u=a(""),m=a(!1),d=a(!1),p=a(!1),f=a(!1),v=a(""),g=a(""),h=a("environment"),b=a(null),y=a(null),_=a(null),C=a(null),S=a(null),w=t(()=>l.value==="camera"),k=t(()=>l.value==="display"),x=t(()=>`${window.location.origin}${window.location.pathname}?room=${i.value}`),V=t(()=>!!navigator.share),M=t(()=>{if(d.value){if(w.value&&!f.value)return{text:"等待連線",indicatorClasses:"bg-yellow-100 text-yellow-800",dotClasses:"bg-yellow-500 animate-pulse"};if(k.value&&!p.value)return{text:"等待串流",indicatorClasses:"bg-yellow-100 text-yellow-800",dotClasses:"bg-yellow-500 animate-pulse"};return{text:"已連線",indicatorClasses:"bg-green-100 text-green-800",dotClasses:"bg-green-500"}}return m.value?{text:"連線中...",indicatorClasses:"bg-blue-100 text-blue-800",dotClasses:"bg-blue-500 animate-spin"}:{text:"未連線",indicatorClasses:"bg-red-100 text-red-800",dotClasses:"bg-red-500"}}),A="font-semibold py-2 px-5 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-4",B=t(()=>`${A} bg-gradient-to-r from-blue-500 to-indigo-600 text-white focus:ring-blue-300`),P=t(()=>`${A} bg-white hover:bg-gray-100 text-gray-800 border border-gray-200 focus:ring-gray-200`),U=t(()=>`${A} bg-red-500 hover:bg-red-600 text-white focus:ring-red-300`),D=(t,c="error",o=4e3)=>{("error"===c?v:g).value=t,setTimeout(()=>("error"===c?v:g).value="",o)},L=()=>{_.value&&_.value.getTracks().forEach(t=>t.stop()),y.value&&y.value.destroy(),b.value&&b.value.disconnect(),_.value=y.value=b.value=null,d.value=p.value=f.value=!1},j=()=>{L(),s.value="home",l.value=null,i.value=u.value=""},q=j,I=async()=>{l.value="camera",i.value=Math.floor(1e3+9e3*Math.random()).toString(),s.value="main",await E()},H=()=>{l.value="display",s.value="displayInput"},R=async()=>{4===u.value.length&&(i.value=u.value,s.value="main",await E())},E=async()=>{if(m.value||d.value)return;m.value=!0;try{w.value&&await O(),await T(),b.value.emit("join-room",i.value),d.value=!0}catch(t){D(`連線失敗: ${t.message}`),j()}finally{m.value=!1}},O=async()=>{try{const t={video:{facingMode:h.value,width:{ideal:1280},height:{ideal:720}},audio:!1};_.value=await navigator.mediaDevices.getUserMedia(t),await n(),C.value&&(C.value.srcObject=_.value)}catch(t){throw console.error("Camera init error:",t),new Error("無法訪問攝影機，請確認已授權。")}},T=()=>new Promise((c,o)=>{b.value=io(r,{reconnectionAttempts:3}),b.value.on("connect",()=>{console.log("Socket connected:",b.value.id),c()}),b.value.on("connect_error",()=>o(new Error("無法連接到伺服器"))),b.value.on("user-joined",t=>{w.value&&W(t.userId)}),b.value.on("offer-received",t=>{k.value&&z(t.signal)}),b.value.on("signal",t=>{y.value&&!y.value.destroyed&&y.value.signal(t.signal)}),b.value.on("user-left",()=>{D("對方已離線","error"),f.value=!1,p.value=!1,y.value&&(y.value.destroy(),y.value=null)})}),F=c=>{c.on("signal",c=>{b.value.emit("forward-signal",{signal:c})}),c.on("connect",()=>f.value=!0),c.on("stream",c=>{p.value=!0,S.value&&(S.value.srcObject=c)}),c.on("close",()=>f.value=!1),c.on("error",c=>D(`P2P連線錯誤: ${c.message}`))},W=c=>{y.value&&y.value.destroy(),y.value=new SimplePeer({initiator:!0,trickle:!1,stream:_.value}),F(y.value)},z=c=>{y.value&&y.value.destroy(),y.value=new SimplePeer({initiator:!1,trickle:!1}),F(y.value),y.value.signal(c)},N=async()=>{h.value="user"===h.value?"environment":"user";try{await O(),y.value&&y.value._pc&&await y.value._pc.getSenders().find(c=>c.track&&"video"===c.track.kind)?.replaceTrack(_.value.getVideoTracks()[0]),D("鏡頭切換成功","success")}catch(t){D(`切換鏡頭失敗: ${t.message}`)}},K=()=>{S.value&&(document.fullscreenElement?document.exitFullscreen():S.value.requestFullscreen().catch(t=>D(`無法進入全螢幕: ${t.message}`)))},$=async()=>{try{await navigator.clipboard.writeText(x.value),D("連結已複製到剪貼簿","success")}catch(t){D("複製失敗，您的瀏覽器可能不支援此功能。")}},G=()=>navigator.share({title:"手機鏡頭即時投影",url:x.value});return o(()=>{const t=new URLSearchParams(window.location.search).get("room");t&&/^\d{4}$/.test(t)&&(u.value=t,H(),R())}),e(()=>L()),{view:s,role:l,isCamera:w,isDisplay:k,roomId:i,inputRoomId:u,isConnecting:m,isConnected:d,hasRemoteStream:p,hasRemoteConnection:f,errorMessage:v,successMessage:g,shareUrl:x,canShare:V,status:M,primaryBtnClasses:B,secondaryBtnClasses:P,dangerBtnClasses:U,localVideo:C,remoteVideo:S,localStream:_,startAsCamera:I,startAsDisplay:H,connectAsDisplay:R,goHome:j,disconnect:q,switchCamera:N,toggleFullscreen:K,copyShareUrl:$,shareViaWeb:G}}}).mount("#app")</script></body></html>